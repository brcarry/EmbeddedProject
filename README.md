# æ´¾è’™è¯­éŸ³åŠ©æ‰‹



## è®¾è®¡ç›®æ ‡

â€‹	å¦‚ä»Šï¼Œè¯¸å¦‚â€œå¤©çŒ«ç²¾çµâ€ï¼Œâ€œå°çˆ±åŒå­¦â€ï¼Œâ€œå°åº¦â€ç­‰æ™ºèƒ½éŸ³ç®±å¯¹äºå¤§å¤šæ•°äººæ¥è¯´åº”è¯¥ä¸é™Œç”Ÿã€‚2022å¹´åº•ï¼Œç”±OpenAIç ”å‘çš„èŠå¤©æœºå™¨äººChatGPTï¼ŒçŸ­çŸ­5å¤©ï¼Œæ³¨å†Œç”¨æˆ·æ•°å°±è¶…è¿‡100ä¸‡ã€‚ChatGPTèƒ½å¤Ÿé€šè¿‡ç†è§£å’Œå­¦ä¹ äººç±»çš„è¯­è¨€æ¥è¿›è¡Œå¯¹è¯ï¼Œè¿˜èƒ½æ ¹æ®èŠå¤©çš„ä¸Šä¸‹æ–‡è¿›è¡Œäº’åŠ¨ï¼ŒçœŸæ­£åƒäººç±»ä¸€æ ·æ¥èŠå¤©äº¤æµã€‚å› ä¸ºå…¶æ˜“ç”¨æ€§ï¼Œä»¥åŠç”Ÿæˆæ–‡æœ¬çš„é«˜è´¨é‡ï¼ŒChatGPTä¹Ÿæˆä¸ºäº†å¤§å®¶æ—¥å¸¸åŠŸèƒ½å’Œå­¦ä¹ ä¸­çš„å¥½åŠ©æ‰‹ï¼Œç”šè‡³å¯ä»¥å¹³æ›¿ç™¾åº¦ã€‚å°±æˆ‘å’Œæˆ‘çš„åŒå­¦è€Œè¨€ï¼ŒChatGPTåœ¨æ—¥å¸¸çš„æ–‡ä¹¦ç±»ä»»åŠ¡çš„æ’°å†™ï¼Œä»£ç çš„debugä»¥è‡³äºæƒ…æ„Ÿäº¤æµéƒ½æä¾›äº†å¾ˆå¤§çš„å¸®åŠ©ã€‚

â€‹	å¦‚æœèƒ½æŠŠChatGPTæ¥å…¥è¯­éŸ³åŠ©æ‰‹å°±å¥½äº†ï¼

â€‹	æ˜¥å­¦æœŸå¼€å§‹ä¸ä¹…çš„3æœˆ2æ—¥ï¼ŒOpenAIå¼€æ”¾äº†å®˜æ–¹çš„APIï¼Œå…è®¸ç¬¬ä¸‰æ–¹å¼€å‘è€…é€šè¿‡APIå°†ChatGPTé›†æˆåˆ°ä»–ä»¬çš„åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¸­ã€‚åœ¨è¯­éŸ³åŠ©æ‰‹ä¸­ä½¿ç”¨ChatGPTæ¥ç”Ÿæˆå¯¹è¯çš„æ¢¦æƒ³å˜å¾—â€œè½»è€Œæ˜“ä¸¾â€ï¼ˆåªè¦è§£å†³ç¿»å¢™çš„é—®é¢˜ï¼Œç„¶åå‚ç…§å®˜æ–¹æ–‡æ¡£è°ƒç”¨APIå°±å¯ä»¥ï¼‰ã€‚ç»¼ä¸Šï¼ŒæŠŠChatGPTæ¥å…¥è¯­éŸ³åŠ©æ‰‹çš„ä»»åŠ¡å°±è§£å†³äº†ã€‚

â€‹	æ­¤å¤–ï¼Œå› ä¸ºæˆ‘æ˜¯ä¸€ä¸ªé‡åº¦çš„åŸç¥ï¼ˆä¸€æ¬¾å¼€æ”¾ä¸–ç•Œæ¸¸æˆï¼‰ç©å®¶ï¼Œå¹¶ä¸”éå¸¸å–œæ¬¢å…¶ä¸­çš„æ´¾è’™ï¼ˆæ´¾è’™æ˜¯æ¸¸æˆä¸­çš„NPCä¹‹ä¸€ï¼‰ï¼Œæ‰€ä»¥ï¼Œæˆ‘å¸Œæœ›ç”¨æ´¾è’™çš„éŸ³æ•ˆæ¥è¿›è¡Œæœ€ç»ˆçš„è¯­éŸ³åˆæˆï¼Œå¹¶ä¸”å¯ä»¥é›†æˆä¸€äº›æœ‰åˆ©äºæ¸¸æˆç©å®¶çš„åŠŸèƒ½ã€‚æ‰€ä»¥æˆ‘é›†æˆå’Œå®ç°çš„åŠŸèƒ½å¦‚ä¸‹ï¼š

> - å¤©æ°”æŸ¥è¯¢
> 
>- æ¸¸æˆä¸€é”®ç­¾åˆ°
> - æ¸¸æˆç¤¾åŒºçƒ­å¸–æŸ¥çœ‹
> - æ´¾è’™è¯­éŸ³æ’­æŠ¥

â€‹	æ•´ä¸ªé¡¹ç›®å·²åœ¨[githubä¸Šå¼€æº](https://github.com/brcarry/Embedded_Project)ã€‚

â€‹	æ•´æ´»è§†é¢‘é“¾æ¥ä¸ºhttps://youtu.be/PoGvY_eOYAcã€‚

## è®¾è®¡è¿‡ç¨‹

### ç³»ç»Ÿæ¡†æ¶

![image-20230420203330872](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230420203330872.png)

â€‹	ä»¥ä¸Šæ˜¯æˆ‘æ•´ä¸ªç³»ç»Ÿçš„ä¸»ä½“æ¡†æ¶ï¼š

â€‹	æ•´ä¸ªç³»ç»Ÿé¦–å…ˆéœ€è¦é€šè¿‡é¢„å…ˆè®¾ç½®çš„å”¤é†’è¯æ¥è¿›è¡Œå”¤é†’æ•´ä¸ªè¯­éŸ³äº¤äº’çš„åŠŸèƒ½ã€‚

â€‹	æ£€æµ‹åˆ°å”¤é†’è¯åï¼Œé€šè¿‡USBéº¦å…‹é£å½•åˆ¶ç”¨æˆ·çš„è¾“å…¥ã€‚ç„¶åè°ƒç”¨ç™¾åº¦apiå®ç°è¯­éŸ³è½¬æ–‡å­—ã€‚

â€‹	è·å¾—è¿”å›çš„æ–‡å­—åï¼Œæˆ‘é€šè¿‡å…³é”®è¯æ£€æµ‹æ¥è¿›è¡Œåˆ¤æ–­ï¼Œå†³å®šè¿™è½®æ˜¯å¦æ‰§è¡Œè¯­éŸ³åŠ©æ‰‹é›†æˆçš„å…·ä½“çš„ä»»åŠ¡ã€‚å¦‚æœéƒ½ä¸æ˜¯çš„è¯ï¼Œåˆ™è°ƒç”¨æ¥å£å°†ä»»åŠ¡äº¤ç»™ChatGPTã€‚

â€‹	ç„¶åï¼Œæˆ‘ä»¬å°†éœ€è¦æ’­æŠ¥çš„å†…å®¹é€šè¿‡æˆ‘åœ¨WSLä¸Šéƒ¨ç½²çš„è¯­éŸ³åˆæˆæœåŠ¡è¿›è¡Œæ´¾è’™éŸ³æ•ˆçš„è¯­éŸ³åˆæˆã€‚

â€‹	æœ€åï¼Œæˆ‘å°†åˆæˆçš„éŸ³é¢‘æ–‡ä»¶ä¼ é€å›æ ‘è“æ´¾ï¼Œå¹¶é€šè¿‡è“ç‰™éŸ³ç®±æ’­æ”¾ã€‚

### ç¯å¢ƒåŠå¤–è®¾

>æ ‘è“æ´¾ä¿¡å·ï¼šæ ‘è“æ´¾ 4b4g
>
>æ“ä½œç³»ç»Ÿï¼šUbuntu 22.04
>
>Pythonç‰ˆæœ¬ï¼šPython 3.10
>
>éŸ³é¢‘è¾“å…¥è®¾å¤‡ï¼šUSBéº¦å…‹é£  [æ·˜å®é“¾æ¥](https://item.taobao.com/item.htm?spm=a1z09.2.0.0.67002e8dFnF72v&id=668895270969&_u=7204s59pbe503b)
>
>éŸ³é¢‘è¾“å‡ºè®¾å¤‡ï¼šè“ç‰™éŸ³ç®±  [æ·˜å®é“¾æ¥](https://detail.tmall.com/item.htm?_u=7204s59pbe2009&id=701050944238&spm=a1z09.2.0.0.67002e8dFnF72v&sku_properties=5919063:6536025)
>
>æ˜¾ç¤ºå±ï¼š7å¯¸IPSé«˜æ¸…è§¦æ‘¸å±  [æ·˜å®é“¾æ¥](https://detail.tmall.com/item.htm?_u=7204s59pbe1962&id=683025543197&spm=a1z09.2.0.0.67002e8dFnF72v)

![image-20230507150821308](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507150821308.png)

### å”¤é†’æ£€æµ‹

â€‹	åœ¨å”¤é†’æ£€æµ‹ä¸Šï¼Œä¸åŒäºå¤§å¤šæ•°åŒå­¦ç›´æ¥é€šè¿‡ç™¾åº¦apiè¯­éŸ³è½¬æ–‡å­—å¹¶è¿›è¡Œåˆ¤æ–­ï¼Œæˆ‘ä½¿ç”¨äº†snowboyè¿›è¡Œç¦»çº¿çš„å”¤é†’æ£€æµ‹ã€‚

â€‹	ä½†å®ç°ç¦»çº¿çš„å”¤é†’æ£€æµ‹çš„åŠŸèƒ½ï¼Œå¹¶ä¸æ˜¯ç›´æ¥cloneä»“åº“å¹¶è¿è¡Œè¿™ä¹ˆè½»æ¾ã€‚

#### å”¤é†’è¯æ¨¡å‹çš„è®­ç»ƒ

â€‹	ç½‘ä¸Šå¯ä»¥æœåˆ°çš„æ•™ç¨‹éƒ½ç›´æ¥é€šè¿‡snowboyå®˜ç½‘æ¥è®­ç»ƒæ¨¡å‹ï¼Œæˆ–è€…ç›´æ¥ä¸‹è½½åˆ«äººè®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œä½†æ˜¯ï¼Œ**snowboyå®˜ç½‘åœ¨2020.03.18æ—¥åå°±å·²ç»åœæ­¢ç»´æŠ¤**ã€‚é€šè¿‡è®¿é—®å®˜ç½‘æ¥è®­ç»ƒæ¨¡å‹æ˜¾ç„¶ä¸ç°å®ã€‚å¥½åœ¨æœ‰å¤§ä½¬è‡ªå·±åˆæ­äº†ä¸€ä¸ªè®­ç»ƒçš„webç«¯https://snowboy.hahack.com/ï¼Œé€šè¿‡ç”µè„‘éº¦å…‹é£å½•åˆ¶ä¸‰æ¡è¯­è¨€ï¼Œå³å¯ç”Ÿæˆé€‚ç”¨äºsnowboyçš„å”¤é†’è¯æ¨¡å‹ã€‚

![image-20230507092157992](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507092157992.png)

â€‹	é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘å¾—åˆ°äº†"paimeng.pmdl"æ–‡ä»¶ï¼Œç”¨äºåç»­çš„å”¤é†’æ¨¡å—ã€‚

#### ç¼–è¯‘åŠ¨æ€åº“

â€‹	cloneä»“åº“åï¼Œsnowboyå¹¶ä¸èƒ½ç›´æ¥è¿è¡Œç¤ºä¾‹è„šæœ¬â€œå¼€ç®±å³ç”¨â€ã€‚éœ€è¦åŸºäºæ“ä½œç³»ç»Ÿç¼–è¯‘å¯¹åº”è¯­è¨€çš„åŠ¨æ€åº“ã€‚

â€‹	é¦–å…ˆï¼Œéœ€è¦å®‰è£…å¯¹åº”çš„ä¾èµ–

```bash
sudo apt install python3-pyaudio
sudo apt install swig
sudo apt install libatlas-base-dev
```

â—ï¸  å®‰è£…ä¾èµ–åº“åï¼Œç›´æ¥makeä»ç„¶ä¼šæŠ¥é”™ï¼š

```bash
make: python3-config: Command not found
make: python3-config: Command not found
swig -I../../ -c++ -python -o snowboy-detect-swig.cc snowboy-detect-swig.i
g++  -I../../ -O3 -fPIC -D_GLIBCXX_USE_CXX11_ABI=0 -std=c++0x -c snowboy-detect-swig.cc
snowboy-detect-swig.cc:181:11: fatal error: Python.h: No such file or directory
  181 | # include <Python.h>
      |           ^~~~~~~~~~
compilation terminated.
make: *** [Makefile:70: snowboy-detect-swig.o] Error 1
```

> è¿™æ˜¯å› ä¸ºLinux å‘è¡Œç‰ˆé€šå¸¸ä¼šæŠŠç±»åº“çš„å¤´æ–‡ä»¶å’Œç›¸å…³çš„ `pkg-config` åˆ†æ‹†æˆä¸€ä¸ªå•ç‹¬çš„ `xxx-dev`ã€‚ä»¥pythonä¸ºä¾‹ï¼Œ`python-dev` åŒ…æ‹¬äº†ä¸€äº›ç”¨ C / Java / C# ç­‰ç¼–å†™çš„ Python æ‰©å±•ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™ä¾èµ–çš„å¤´æ–‡ä»¶ç­‰ä¿¡æ¯ã€‚åœ¨ç¼–è¯‘ä¸€ä¸ªç”¨ C è¯­è¨€ç¼–å†™çš„ Python æ‰©å±•æ¨¡å—æ—¶ï¼Œå› æ­¤éœ€è¦å…ˆå®‰è£… `python-dev`å¼€å‘åŒ…ã€‚

```bash
sudo apt install python3-dev
```

â€‹	ä¹‹åå†makeï¼Œé—®é¢˜è§£å†³ï¼Œç”Ÿæˆäº†`_snowboydetect.so`æ–‡ä»¶ã€‚åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡Œå®˜æ–¹æä¾›çš„è„šæœ¬è¿›è¡Œæµ‹è¯•ã€‚ä»¥ä¸‹ä¸ºæœ¬é¡¹ç›®ä¸­ï¼ŒåŸºäºsnowboyè¯­éŸ³å”¤é†’æ¨¡å—çš„æµ‹è¯•ä»£ç ã€‚

```python
import snowboydecoder
import sys
import signal

interrupted = False

def signal_handler(signal, frame):
    global interrupted
    interrupted = True

# æ£€æŸ¥æ˜¯å¦æœ‰ä¸­æ–­
def interrupt_callback():
    global interrupted
    return interrupted

# æ¨¡å‹è·¯å¾„
model = "resources/models/paimeng.pmdl"

# æ•è·SIGINTä¿¡å·
signal.signal(signal.SIGINT, signal_handler)

# å¦‚æœæœ‰è¯­éŸ³è¾“å…¥ï¼Œè°ƒç”¨snowboyçš„HotwordDetectorå‡½æ•°è¿›è¡Œæ£€æµ‹
detector = snowboydecoder.HotwordDetector(model, sensitivity=0.5)
print('Listening... Press Ctrl+C to exit')

# ä¸»å¾ªç¯
detector.start(detected_callback=snowboydecoder.play_audio_file,
               interrupt_check=interrupt_callback,
               sleep_time=0.03)

detector.terminate()
```

![image-20230507095232944](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507095232944.png)

â€‹	å”¤é†’è¯æ£€æµ‹æ¨¡å—å·¥ä½œæ­£å¸¸ã€‚

### ç”¨æˆ·è¯­éŸ³è¾“å…¥

â€‹	ä¸ºäº†å½•åˆ¶ç”¨æˆ·çš„è¯­éŸ³ï¼Œæˆ‘ä½¿ç”¨äº†`pyaudio`è¿™ä¸ªåº“ã€‚æœ¬æ¨¡å—å…·ä½“çš„å·¥ä½œæµç¨‹ä¸ºï¼š

- æ‰“å¼€ä¸€ä¸ªéŸ³é¢‘æµ
- ç­‰å¾…ç”¨æˆ·å¼€å§‹è¯´è¯
- å½•åˆ¶è¯­éŸ³å¹¶æ£€æµ‹æ˜¯å¦ç»“æŸ
- ä¿å­˜éŸ³é¢‘æ–‡ä»¶

â€‹	é¦–å…ˆï¼Œæˆ‘å°è¯•äº†å›ºå®šæ—¶é•¿çš„è¯­éŸ³å½•åˆ¶ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼ˆåœ¨æœ¬æµ‹è¯•æ–‡ä»¶ä¸­ï¼Œæˆ‘è®¾å®šå½•åˆ¶æ—¶é•¿ä¸ºå›ºå®šçš„5ç§’`RECORD_SECONDS = 5`ï¼‰ï¼š

```python
import pyaudio
import wave

CHUNK = 1024
FORMAT = pyaudio.paInt16
CHANNELS = 1
RATE = 16000
RECORD_SECONDS = 5
WAVE_OUTPUT_FILENAME = "output.wav"

# åˆ›å»º pyaudio å¯¹è±¡
p = pyaudio.PyAudio()

# æ‰“å¼€ä¸€ä¸ªéŸ³é¢‘æµ
stream = p.open(format=FORMAT,
                channels=CHANNELS,
                rate=RATE,
                input=True,
                frames_per_buffer=CHUNK)

print("å¼€å§‹å½•éŸ³...")

# ä»éŸ³é¢‘æµä¸­è¯»å–æ•°æ®
frames = []
for i in range(0, int(RATE / CHUNK * RECORD_SECONDS)):
    data = stream.read(CHUNK)
    frames.append(data)

print("å½•éŸ³ç»“æŸï¼")

# å°†å½•åˆ¶çš„éŸ³é¢‘ä¿å­˜ä¸º wav æ–‡ä»¶
wf = wave.open(WAVE_OUTPUT_FILENAME, 'wb')
wf.setnchannels(CHANNELS)
wf.setsampwidth(p.get_sample_size(FORMAT))
wf.setframerate(RATE)
wf.writeframes(b''.join(frames))
wf.close()

# å…³é—­éŸ³é¢‘æµå’Œ pyaudio å¯¹è±¡
stream.stop_stream()
stream.close()
p.terminate()
```

â€‹	ä½†æ˜¾ç„¶ï¼Œé‡‡ç”¨å›ºå®šæ—¶é•¿å¹¶ä¸å¤Ÿçµæ´»ï¼Œæ‰€ä»¥æˆ‘å¯¹ä¸Šè¿°ä»£ç è¿›è¡Œäº†æ”¹è¿›ï¼Œä»¥éŸ³é¢‘å¼ºåº¦ä¸ºå‚ç…§ï¼Œè¿›è¡Œé™éŸ³æ£€æµ‹ä»¥åŠç”¨æˆ·è¾“å…¥æ£€æµ‹çš„åˆ¤æ–­ã€‚å…¶ä¸­ï¼Œ`THRESHOLD `å°±æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œæ˜¯ç”¨æ¥åŒºåˆ†æ˜¯å¦ç”¨æˆ·åœ¨è¯´è¯çš„é˜ˆå€¼ã€‚`silent_counter`åˆ™æ˜¯ç”¨æ¥ç»Ÿè®¡ï¼Œå¼€å§‹å½•åˆ¶åï¼Œç”¨æˆ·åœé¡¿çš„æ—¶é—´ã€‚è¿™æ˜¯ä¸ºäº†æä¾›ä¸€ä¸ªè£•åº¦ï¼Œå› ä¸ºå¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬å¹³å¸¸è¯´è¯çš„æ—¶å€™ä¹Ÿä¸æ˜¯ä¸€å­—ä¸åœï¼Œä¸€å£æ°”è¯´åˆ°åº•ã€‚åœ¨è¯´è¯æ—¶ï¼Œä¼šæœ‰çŸ­æš‚çš„åœé¡¿ã€‚æ”¹è¿›åï¼Œä»£ç å¦‚ä¸‹ï¼š

```python
import pyaudio
import wave
import time
import struct

CHUNK = 1024
FORMAT = pyaudio.paInt16
CHANNELS = 1
RATE = 16000
WAVE_OUTPUT_FILENAME = "output.wav"

THRESHOLD = 300

# åˆ›å»º pyaudio å¯¹è±¡
p = pyaudio.PyAudio()

# æ‰“å¼€ä¸€ä¸ªéŸ³é¢‘æµ
stream = p.open(format=FORMAT,
                channels=CHANNELS,
                rate=RATE,
                input=True,
                frames_per_buffer=CHUNK)

print("ç­‰å¾…ç”¨æˆ·å¼€å§‹è¯´è¯...")

# ç­‰å¾…ç”¨æˆ·å¼€å§‹è¯´è¯
while True:
    data = stream.read(CHUNK)

    max_value = 0
    data_int = struct.unpack(f'{CHUNK}h', data)
    max_value = max(data_int)
    # print(max_value) # debugç”¨

    # å¦‚æœå£°éŸ³å¤Ÿå¤§ï¼Œè¯´æ˜ç”¨æˆ·å¼€å§‹è¾“å…¥ï¼Œç»“æŸç­‰å¾…çŠ¶æ€ï¼Œå¼€å§‹å½•åˆ¶
    if max_value > THRESHOLD:
        break

print("å¼€å§‹å½•éŸ³...")

# å¼€å§‹å½•éŸ³
frames = [data]
silent_counter = 0
while True:
    data = stream.read(CHUNK)
    frames.append(data)

    data_int = struct.unpack(f'{CHUNK}h', data)
    max_value = max(data_int)
	
    # å¦‚æœæ­¤æ—¶éŸ³é‡è¾ƒå°ï¼Œåˆ™silent_counter + 1
    # ä½†å¦‚æœæœ‰è¶…è¿‡é˜ˆå€¼çš„éŸ³é‡ï¼Œé‚£ä¹ˆè¯´æ˜ç”¨æˆ·åœé¡¿ååˆç»§ç»­å¼€å§‹è¯´è¯ï¼Œé‚£ä¹ˆéœ€è¦å°†silent_counteræ¸…é›¶
    silent_counter = silent_counter + 1 if max_value < THRESHOLD else 0
    # æ­¤å¤„è®¾ç½®ä¸ºï¼Œè¶…è¿‡ä¸‰ç§’ï¼Œè§†ä½œç”¨æˆ·è¾“å…¥ç»“æŸ
    if silent_counter > RATE // CHUNK * 3:
        break

print("å½•éŸ³ç»“æŸï¼")

# å°†å½•åˆ¶çš„éŸ³é¢‘ä¿å­˜ä¸º wav æ–‡ä»¶
wf = wave.open(WAVE_OUTPUT_FILENAME, 'wb')
wf.setnchannels(CHANNELS)
wf.setsampwidth(p.get_sample_size(FORMAT))
wf.setframerate(RATE)
wf.writeframes(b''.join(frames))
wf.close()

# å…³é—­éŸ³é¢‘æµå’Œ pyaudio å¯¹è±¡
stream.stop_stream()
stream.close()
p.terminate()
```

â€‹	é€šè¿‡æ£€æŸ¥ä¿å­˜çš„éŸ³é¢‘æ–‡ä»¶`output.wav`ï¼Œå¯ä»¥åˆ¤æ–­æœ¬æ¨¡å—æ­£å¸¸å·¥ä½œã€‚

### è¯­éŸ³è½¬æ–‡å­—ï¼ˆSTTï¼‰

â€‹	åœ¨æœ¬æ¨¡å—ï¼Œæˆ‘ä½¿ç”¨äº†ç™¾åº¦çš„apiã€‚æ³¨å†Œè´¦å·åï¼Œå¯ä»¥é¢†å–å…è´¹èµ„æºã€‚æœ‰15ä¸‡æ¬¡è¯­éŸ³è¯†åˆ«ï¼Œå’Œ5ä¸‡æ¬¡è¯­éŸ³åˆæˆã€‚åœ¨æœ¬é¡¹ç›®çš„è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ‰ç”¨äº†ä¸€ç™¾æ¡å·¦å³ï¼Œæ‰€ä»¥ä¸éœ€è¦ä»˜è´¹ï¼Œç”¨å®˜æ–¹èµ é€çš„å…è´¹èµ„æºä¹Ÿæ˜¯æˆ³æˆ³æœ‰ä½™çš„ã€‚

![image-20230507101631749](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507101631749.png)

â€‹	é˜…è¯»æ–‡æ¡£å¯çŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹pidå‚æ•°ï¼ŒæŒ‡å®šå…·ä½“çš„è¯­éŸ³è¯†åˆ«ä»»åŠ¡çš„è¯­è¨€ï¼š

| 1537 | æ™®é€šè¯(çº¯ä¸­æ–‡è¯†åˆ«) | è¯­éŸ³è¿‘åœºè¯†åˆ«æ¨¡å‹ | æœ‰æ ‡ç‚¹ | æ”¯æŒè‡ªå®šä¹‰è¯åº“   |
| ---- | ------------------ | ---------------- | ------ | ---------------- |
| 1737 | è‹±è¯­               |                  | æ— æ ‡ç‚¹ | ä¸æ”¯æŒè‡ªå®šä¹‰è¯åº“ |
| 1637 | ç²¤è¯­               |                  | æœ‰æ ‡ç‚¹ | ä¸æ”¯æŒè‡ªå®šä¹‰è¯åº“ |
| 1837 | å››å·è¯             |                  | æœ‰æ ‡ç‚¹ | ä¸æ”¯æŒè‡ªå®šä¹‰è¯åº“ |
| 1936 | æ™®é€šè¯è¿œåœº         | è¿œåœºæ¨¡å‹         | æœ‰æ ‡ç‚¹ | ä¸æ”¯æŒ           |

â€‹	æœ¬æ¨¡å—çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼ˆå‡ºäºéšç§è€ƒè™‘ï¼Œæˆ‘æŠŠæˆ‘çš„è´¦å·ä¿¡æ¯å’Œapi keyéšå»äº†ï¼‰ï¼š

```python
from aip import AipSpeech

# æ›¿æ¢ä¸ºæ‚¨çš„ç™¾åº¦ API å¯†é’¥
BAIDU_APP_ID = 'xxx'
BAIDU_API_KEY = 'xxx'
BAIDU_SECRET_KEY = 'xxx'

# åˆ›å»ºä¸€ä¸ª AipSpeech å¯¹è±¡
client = AipSpeech(BAIDU_APP_ID, BAIDU_API_KEY, BAIDU_SECRET_KEY)


def recognize_wav_file(filename):
    with open(filename, 'rb') as file:
        audio_data = file.read()
	
    # è®¾ç½®dev_pidä¸º1537ï¼Œå³æ™®é€šè¯(çº¯ä¸­æ–‡è¯†åˆ«)
    response = client.asr(audio_data, 'wav', 16000, {'dev_pid': 1537})

    if response['err_no'] == 0:
        text = response['result'][0]
        return text
    else:
        print(f"è¯†åˆ«é”™è¯¯ï¼š{response['err_no']} - {response['err_msg']}")
        return None


# è®¾ç½®ä¿å­˜çš„ WAV æ–‡ä»¶è·¯å¾„
wav_file_path = "output.wav"

recognized_text = recognize_wav_file(wav_file_path)

if recognized_text:
    print(f"è¯†åˆ«ç»“æœï¼š{recognized_text}")
else:
    print("è¯†åˆ«å¤±è´¥")
```

### æ‰§è¡Œå…·ä½“ä»»åŠ¡

â€‹	åœ¨å¾—åˆ°è¯­éŸ³è¯†åˆ«çš„ç»“æœåï¼Œæˆ‘é€šè¿‡åˆ¤æ–­åˆ†æ”¯çš„è¯­å¥ï¼Œè®©è¯­éŸ³åŠ©æ‰‹æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åˆ†æ”¯çš„åˆ¤æ–­æ¯”è¾ƒç®€å•ç²—æš´ï¼Œå°±æ˜¯é€šè¿‡å…³é”®è¯æ£€æµ‹

```python
# åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æ®Šä»»åŠ¡
if text == "ä¸€é”®ç­¾åˆ°ã€‚":
    response_text = u_tasks.signYS()
elif text == "æˆ‘è¦çœ‹å¸–å­ã€‚":
    response_text = u_tasks.getYSArticle()
elif u_tasks.is_query_weather(text):
    response_text = u_tasks.query_weather(text)
else:
    # è‹¥éƒ½ä¸æ˜¯ï¼Œåˆ™è°ƒç”¨chatgptçš„apiç”Ÿæˆå›å¤
    response_text = generate_response(text)
```

#### å¤©æ°”æŸ¥è¯¢

â€‹	å¤©æ°”æŸ¥è¯¢åŠŸèƒ½ï¼Œæˆ‘ä½¿ç”¨äº†çŸ¥å¿ƒå¤©æ°”çš„apiã€‚å¿ƒçŸ¥å¤©æ°”å…è´¹ç‰ˆè®¿é—®é¢‘é™20æ¬¡/åˆ†é’Ÿä½†æ— é™è®¿é—®é‡ï¼Œæ— è¿‡æœŸæ—¶é—´ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼ˆå‡ºäºéšç§è€ƒè™‘ï¼Œæˆ‘æŠŠæˆ‘çš„è´¦å·ä¿¡æ¯å’Œapi keyéšå»äº†ï¼‰ï¼š

â€‹	åœ¨åˆ¤æ–­ç”¨æˆ·çš„è¾“å…¥æ˜¯å¦ä¸ºå¤©æ°”æŸ¥è¯¢çš„ä»»åŠ¡æ—¶ï¼Œæˆ‘é‡‡ç”¨äº†å…³é”®è¯æ£€æµ‹çš„æ–¹å¼ã€‚å…ˆé€šè¿‡`jieba`è¿™ä¸ªåº“å¯¹æŸ¥è¯¢è¯­å¥è¿›è¡Œåˆ†è¯ï¼Œç„¶åæ£€æµ‹æ˜¯å¦å­˜åœ¨'å¤©æ°”', 'æ°”æ¸©', 'æ¸©åº¦'ç­‰å…³é”®è¯ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šjiebaåˆ†è¯æœ‰ä¸‰ç§ä¸åŒçš„åˆ†è¯æ¨¡å¼ï¼š**ç²¾ç¡®æ¨¡å¼ã€å…¨æ¨¡å¼å’Œæœç´¢å¼•æ“æ¨¡å¼**ã€‚

```python
jieba.lcut(sentence,cut_all=False) # ç²¾ç¡®æ¨¡å¼
jieba.lcut(sentence,cut_all=True) # å…¨æ¨¡å¼
jieba.lcut_for_search (sentence) # æœç´¢å¼•æ“æ¨¡å¼
```

â€‹	å¯¹äºâ€œä»Šå¤©å¤©æ°”çœŸå¥½â€ï¼Œä¸‰è€…åˆ’åˆ†ç»“æœå¦‚ä¸‹ï¼š

```python
'ä»Šå¤©å¤©æ°” çœŸ å¥½' # ç²¾ç¡®æ¨¡å¼
'ä»Šå¤© ä»Šå¤©å¤©æ°” å¤©å¤© å¤©æ°” çœŸå¥½' # å…¨æ¨¡å¼
'ä»Šå¤© å¤©å¤© å¤©æ°” ä»Šå¤©å¤©æ°” çœŸ å¥½' # æœç´¢å¼•æ“æ¨¡å¼
```

â€‹	å…¶ä¸­ï¼Œç²¾ç¡®æ¨¡å¼ä¼šå°†â€œä»Šå¤©å¤©æ°”â€åˆå¹¶åœ¨ä¸€èµ·ï¼Œå¯¼è‡´æˆ‘ç®€å•ç²—æš´çš„å…³é”®è¯åˆ¤æ–­æ–¹æ³•å¤±æ•ˆï¼Œè€Œåä¸¤ç§æ¨¡å¼éƒ½å¯ä»¥åˆ’åˆ†å‡ºâ€œå¤©æ°”â€ï¼Œåœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†æœç´¢å¼•æ“æ¨¡å¼ã€‚

â€‹	åœ¨æŸ¥è¯¢å¤©æ°”æ—¶æˆ‘å…ˆé€šè¿‡`jieba`è¿™ä¸ªåº“å¯¹æŸ¥è¯¢è¯­å¥è¿›è¡Œåˆ†è¯ï¼Œå¹¶æ‰¾å‡ºå…¶ä¸­çš„åœ°åã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™é»˜è®¤æ˜¯æ­å·ã€‚ç„¶åé€šè¿‡`requests`åº“å‘èµ·è¯·æ±‚ï¼Œæœ€åå¯¹è¿”å›çš„jsonæ–‡ä»¶è¿›è¡Œè§£æã€‚

```python
def is_query_weather(text):
    # if(text=="æŸ¥è¯¢å¤©æ°”")
    # return True
    if text == "æŸ¥è¯¢å¤©æ°”":
        return True

    # å®šä¹‰å…³é”®è¯åˆ—è¡¨
    keywords = ['å¤©æ°”', 'æ°”æ¸©', 'æ¸©åº¦']
    words = jieba.lcut_for_search (text)
    print(words)
    # æ£€æŸ¥æ˜¯å¦åŒ…å«å…³é”®è¯
    if any(word in keywords for word in words):
        return True
    else:
        return False

def query_weather(text):
    words = pseg.cut(text)
    city = "æ­å·"
    for word, flag in words:
        if flag == 'ns':  # ns è¡¨ç¤ºåœ°å
            city = word
            break

    params = {
        # "key": "ä½ çš„APIå¯†é’¥",
        "key": "xxx",
        "location": city, # è®¾ç½®æŸ¥è¯¢åœ°ç‚¹
        "language": "zh-Hans",
        "unit": "c",
    }
    url = "https://api.seniverse.com/v3/weather/now.json"
    r = requests.get(url, params=params)
    # è§£ææ•°æ®
    data = r.json()["results"]

    ret = ""
    ret += data[0]["location"]["name"]
    ret += "çš„å¤©æ°”æ˜¯"
    ret += data[0]["now"]["text"]

    print(ret)
    return ret
```

![image-20230507105024599](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507105024599.png)

â€‹	å¯ä»¥å‘ç°ï¼Œå¿ƒçŸ¥å¤©æ°”è™½ç„¶å…è´¹ï¼Œä½†æ˜¯è¿”å›çš„ç»“æœæ¯”è¾ƒç®€å•`'now': {'text': 'æ™´', 'code': '0', 'temperature': '22'}`ã€‚åæ¥ï¼Œå—åˆ°è€å¸ˆä¸Šè¯¾é€šè¿‡æ­å·æ°”è±¡å®˜ç½‘çˆ¬å–å¤©æ°”æ•°æ®çš„å¯å‘ï¼Œæˆ‘å°†å¯¹äºæ­å·æœ¬åœ°çš„å¤©æ°”çš„æŸ¥è¯¢ï¼Œé€šè¿‡æ­å·æ°”è±¡å®˜æ–¹è¿›è¡Œçˆ¬å–ã€‚è€Œä¸æ˜¯ç»Ÿä¸€çš„è°ƒç”¨å¿ƒçŸ¥å¤©æ°”çš„apiã€‚

â€‹	æœ€åˆï¼Œæˆ‘å°è¯•ç›´æ¥é€šè¿‡åœ¨ç½‘ç«™æºç ä¸­å®šä½ï¼Œè·å¾—æ•°æ®ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š
```python
response = requests.get(url, headers=headers)
content_type = response.headers.get('Content-Type')

if response.status_code == 200:
    soup = BeautifulSoup(response.content, 'html.parser', from_encoding='utf-8')
```

â€‹	ä½†æ˜¯ä»¥å¤±è´¥å‘Šç»ˆï¼Œå› ä¸º`requests`è·å–ç½‘ç«™æºç ï¼Œåªèƒ½è·å¾—é™æ€çš„htmlæ–‡ä»¶ã€‚å…¶ä¸­ï¼Œä¸â€œå…·ä½“é¢„æŠ¥â€ç›¸å…³çš„éƒ¨åˆ†ï¼Œæ˜¯é€šè¿‡jsè„šæœ¬è·å–çš„ã€‚è¿™éƒ¨åˆ†ä»£ç åœ¨é™æ€htmlä¸­ä¸ºï¼Œ`<li id="forecastDetail"></li>`è¿™éƒ¨åˆ†ï¼Œæ˜¾ç„¶è¿™åœ¨é™æ€çš„htmlä¸­æ˜¯ä¸å­˜åœ¨çš„ï¼Œè¯¥éƒ¨åˆ†å†…å®¹æ˜¯ç”±JavaScriptåŠ¨æ€åŠ è½½çš„ï¼š

```html
<div class="weather_tab">
    <ul class="tab">
        <li class="current" style="border-right:1px solid #FFF; width:30%">
            å…·ä½“é¢„æŠ¥
        </li>
        <li style="border-right:1px solid #FFF; width:35%">
            ä¸‰å°æ—¶å¤©æ°”
        </li>
        <li style="width:34%">
            ä¸Šä¸‹ç­å¤©æ°”
        </li>
    </ul>
    <div class="weatherO_con">
        <ul class="block" >
            <li id="forecastDetail"></li>
        </ul>
        <ul>
            <li id="forecast3Detail"></li>
        </ul>
        <ul>
            <li id="sxbDetail"></li>
        </ul>
    </div>
</div>
```

â€‹	æ‰€ä»¥ï¼Œåªèƒ½è½¬å˜æ€è·¯ï¼Œé€šè¿‡chromeçš„å¼€å‘è€…å·¥å…·çš„networké€‰é¡¹å¡ï¼Œæ‰¾åˆ°å…·ä½“é¢„æŠ¥è¯·æ±‚çš„ç›®æ ‡åœ°å€ï¼Œç„¶åé€šè¿‡`requests`åº“å‘èµ·è¯·æ±‚ä»¥è·å¾—å†…å®¹ã€‚

![image-20230507105428187](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507105428187.png)

![image-20230507105611520](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507105611520.png)

â€‹	ç‰¹åˆ«çš„ï¼ŒåŠ¡å¿…éœ€è¦å†™è¯·æ±‚å¤´ï¼Œå¦åˆ™æœåŠ¡å™¨ä¼šæ‹’ç»è®¿é—®ï¼Œå¹¶è¿”å›403ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```python
import requests

url = 'https://www.hzqx.com/hztq/data/actualNewestData/58457.json'

headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
    "Content-type":"application/x-www-form-urlencoded",
    "Accept-Language": "zh-CN,zh;q=0.9",
    "Accept-Encoding": "gzip, deflate, br",
    "Cookie":""
}

response = requests.get(url, headers=headers)

if response.status_code == 200:
    content_json = response.json()
    print(content_json)
    print(content_json['forecast1'])

    text = content_json['forecast1']
    text = text.split("ï¼š", 1)
    text = text[1]
    text = text.replace('%','')
    print(text)
else:
    print(f'è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š{response.status_code}')
```

![image-20230507105856192](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507105856192.png)

â€‹	è¿™æ ·ï¼Œæˆ‘ä»¬å°±è·å¾—äº†æ›´åŠ å…·ä½“ç²¾ç¡®çš„æ­å·çš„å¤©æ°”ã€‚

#### ä¸€é”®ç­¾åˆ°&æŸ¥çœ‹å¸–å­

â€‹	ä¹Ÿæ˜¯åŒæ ·çš„ä½¿ç”¨äº†`requests`åº“å®ç°çˆ¬è™«ï¼Œä½†æ˜¯ä¸ºäº†å®ç°ç­¾åˆ°å’Œå¸–å­çš„æŸ¥çœ‹ï¼Œéœ€è¦å…ˆæ¨¡æ‹Ÿç™»å½•ã€‚æ­¤éƒ¨åˆ†ï¼Œæˆ‘å‚è€ƒäº†GitHubä¸Šå¼€æºçš„æ¸¸æˆåŠ©æ‰‹å·¥å…·â€œç±³æ¸¸å¸â€ï¼š

â€‹	é¦–å…ˆï¼Œå‘"https://webapi.account.mihoyo.com/Api/cookie_accountinfo_by_loginticket?login_ticket={}"å‘èµ·è¯·æ±‚æ‹¿åˆ°`stuid`

â€‹	ç„¶åå‘https://api-takumi.mihoyo.com/auth/api/getMultiTokenByLoginTicket?login_ticket={}&token_types=3&uid={}å‘èµ·è¯·æ±‚ï¼Œæ‹¿åˆ°`stoken`

â€‹	å‚è€ƒé¡¹ç›®â€œç±³æ¸¸å¸â€çš„ä»£ç å°†æ•´ä¸ªæ¨¡æ‹Ÿç™»å½•çš„è¿‡ç¨‹å°è£…ä¸ºä¸€ä¸ªç±»ï¼Œåœ¨ç±»çš„åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨ä»¥ä¸‹ä¸ç™»å½•ç›¸å…³çš„å‡½æ•°æ‹¿åˆ°Cookieå€¼ï¼š

```python
# md5åŠ å¯†
def md5(text):
    md5 = hashlib.md5()
    md5.update(text.encode())
    return md5.hexdigest()

# ç”ŸæˆæŒ‡å®šä½æ•°éšæœºå­—ç¬¦ä¸²
def randomStr(n):
    return (''.join(random.sample(string.ascii_lowercase, n))).upper()

# ç”ŸæˆDS
def DSGet():
    n = salt
    i = str(int(time.time()))
    r = randomStr(6)
    c = md5("salt=" + n + "&t=" + i + "&r=" + r)
    return "{},{},{}".format(i, r, c)


def DSGet2(q: str="", b: str="") -> str:
    n = salt2
    i = str(int(time.time()))
    r = str(random.randint(100001, 200000))
    add = f'&b={b}&q={q}'
    c = md5("salt=" + n + "&t=" + i + "&r=" + r + add)
    return f"{i},{r},{c}"

# è·å–Cookie
def getCookie(cookie):
    Cookie = {}
    if "login_ticket" in cookie:
        cookie = cookie.split(";")
        for i in cookie:
            if i.split("=")[0] == " login_ticket":
                Cookie["login_ticket"] = i.split("=")[1]
                break
        req = requests.get(url=cookieUrl.format(Cookie["login_ticket"]))
        data = json.loads(req.text.encode('utf-8'))
        if "æˆåŠŸ" in data["data"]["msg"]:
            Cookie["stuid"] = str(data["data"]["cookie_info"]["account_id"])
            req = requests.get(url=cookieUrl2.format(Cookie["login_ticket"], Cookie["stuid"]))
            data = json.loads(req.text.encode('utf-8'))
            Cookie["stoken"] = data["data"]["list"][0]["token"]
            print("ç™»å½•æˆåŠŸï¼")
            return [1, Cookie]
        else:
            print("cookieå·²å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•ç±³æ¸¸ç¤¾æŠ“å–cookie")
            return [0, "cookieå·²å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•ç±³æ¸¸ç¤¾æŠ“å–cookie"]
    else:
        print("cookieä¸­æ²¡æœ‰'login_ticket'å­—æ®µ,è¯·é‡æ–°ç™»å½•ç±³æ¸¸ç¤¾ï¼Œé‡æ–°æŠ“å–cookie!")
        return [0, "cookieä¸­æ²¡æœ‰'login_ticket'å­—æ®µ,è¯·é‡æ–°ç™»å½•ç±³æ¸¸ç¤¾ï¼Œé‡æ–°æŠ“å–cookie!"]
```

â€‹	ä¹‹åå°†è¯¥å†…å®¹åŠ å…¥åˆ°è¯·æ±‚å¤´ä¸­ï¼Œä½¿ç”¨`requests`åº“æ—¢å¯å®ç°ç­¾åˆ°å’ŒæŸ¥è¯¢å¸–å­çš„åŠŸèƒ½ï¼Œæœ¬éƒ¨åˆ†è¾ƒä¸ºå¸¸è§„ã€‚ç­¾åˆ°&æŸ¥çœ‹å¸–å­å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```python
def signInYS(self):
    log.info("æ­£åœ¨ç­¾åˆ°......")
    header = {}
    header.update(self.headers)
    ys = gameList[1]

    header["DS"] = DSGet2("", json.dumps({"gids": ys["id"]}))
    req = requests.post(url=signUrl, json={"gids": ys["id"]}, cookies=self.Cookie, headers=header)
    data = json.loads(req.text.encode('utf-8'))
    if "err" not in data["message"]:
        log.info(str(ys["name"]+ data["message"]))
        time.sleep(2)
        if "æˆåŠŸ" in data["message"]:
            return True
        else:
            return False
        else:
            log.info("ç­¾åˆ°å¤±è´¥ï¼Œä½ çš„cookieå¯èƒ½å·²è¿‡æœŸï¼Œè¯·é‡æ–°è®¾ç½®cookieã€‚")
            with open(f"{PATH}/cookie.json", "w") as f:
                f.write('')
                f.close()
                return False
 
def returnArticles(self):
    List = []
    ret_str = ""
    log.info("æ­£åœ¨è·å–å¸–å­åˆ—è¡¨......")
    ys = gameList[1]

    req = requests.get(url=listUrl.format(ys["forumId"]), headers=self.headers)
    data = json.loads(req.text.encode('utf-8'))
    # è·å–åä¸ªå¸–å­
    for n in range(10):
        List.append(data["data"]["list"][n]["post"]["subject"])
        ret_str += str(n+1)+"."+data["data"]["list"][n]["post"]["subject"] + "\n"
        return ret_str
```

![image-20230507114035037](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507114035037.png)

#### ä½¿ç”¨chatgptç”Ÿæˆå¯¹è¯

â€‹	å¦‚æœç”¨æˆ·çš„è¾“å…¥ä¸æ˜¯ä»¥ä¸Šä»»ä½•ç‰¹æ®Šå‘½ä»¤çš„è¯ï¼Œè¯­éŸ³åŠ©æ‰‹å°†è°ƒç”¨open aiçš„æ¥å£ï¼Œç”Ÿæˆå¯¹è¯ã€‚ GPT-4 ç›®å‰å¤„äº `Limited beta` é˜¶æ®µï¼Œåªæœ‰è·å¾—è®¿é—®æƒé™çš„äººæ‰èƒ½è®¿é—®ã€‚GPT-3.5 æ¨¡å‹å¯ä»¥ç†è§£å’Œç”Ÿæˆè‡ªç„¶è¯­è¨€æˆ–ä»£ç ã€‚ç½‘ä¸Šå¯ä»¥æŸ¥åˆ°çš„å¤§å¤šæ•°æ•™ç¨‹éƒ½ä½¿ç”¨çš„æ˜¯`text-davinci-002`ã€‚åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†åœ¨ GPT-3.5 ç³»åˆ—ä¸­åŠŸèƒ½æœ€å¼ºå¤§ã€æœ€å…·æˆæœ¬æ•ˆç›Šçš„å‹å·`gpt-3.5-turbo`ï¼Œå®ƒå·²é’ˆå¯¹èŠå¤©è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½†ä¹Ÿé€‚ç”¨äºä¼ ç»Ÿçš„è¡¥å…¨ï¼ˆCompletionï¼‰ä»»åŠ¡ã€‚ä»¥ä¸‹æ‘˜è‡ªå®˜æ–¹æ–‡æ¡£ï¼š

| MODEL              | æè¿°                                                         | æœ€å¤§ Token æ•° | è®­ç»ƒæ•°æ®          |
| ------------------ | ------------------------------------------------------------ | ------------- | ----------------- |
| gpt-3.5-turbo      | åŠŸèƒ½æœ€å¼ºå¤§çš„ GPT-3.5 å‹å·ï¼Œé’ˆå¯¹èŠå¤©è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæˆæœ¬ä»…ä¸º `text-davinci-003` çš„ 1/10ã€‚å°†ä½¿ç”¨æˆ‘ä»¬æœ€æ–°çš„æ¨¡å‹è¿­ä»£è¿›è¡Œæ›´æ–°ã€‚ | 4096 Token    | æˆªè‡³ 2021 å¹´ 9 æœˆ |
| gpt-3.5-turbo-0301 | `gpt-3.5-turbo` 2023 å¹´ 3 æœˆ 1 æ—¥çš„å¿«ç…§ã€‚ä¸ `gpt-3.5-turbo` ä¸åŒï¼Œæ­¤æ¨¡å‹ä¸ä¼šæ›´æ–°ï¼Œå¹¶ä¸”ä»…åœ¨ 2023 å¹´ 6 æœˆ 1 æ—¥ç»“æŸçš„ä¸‰ä¸ªæœˆå†…æä¾›æ”¯æŒã€‚ | 4096 Token    | æˆªè‡³ 2021 å¹´ 9 æœˆ |
| text-davinci-003   | å¯ä»¥ä»¥æ¯” curieã€babbageã€ada æ¨¡å‹æ›´å¥½çš„è´¨é‡ã€æ›´é•¿çš„è¾“å‡ºå’Œä¸€è‡´çš„æŒ‡ä»¤éµå¾ªæ¥å®Œæˆä»»ä½•è¯­è¨€ä»»åŠ¡ã€‚è¿˜æ”¯æŒåœ¨æ–‡æœ¬ä¸­ [æ’å…¥](https://platform.openai.com/docs/guides/completion/inserting-text)è¡¥å…¨ã€‚ | 4097 Token    | æˆªè‡³2021å¹´6æœˆ     |
| text-davinci-002   | ä¸ `text-davinci-003` ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†ä½¿ç”¨ç›‘ç£å¾®è°ƒè€Œä¸æ˜¯å¼ºåŒ–å­¦ä¹ è¿›è¡Œè®­ç»ƒ | 4097 Token    | æˆªè‡³2021å¹´6æœˆ     |
| code-davinci-002   | é’ˆå¯¹ä»£ç å®Œæˆä»»åŠ¡è¿›è¡Œäº†ä¼˜åŒ–                                   | 8001 Token    | æˆªè‡³2021å¹´6æœˆ     |

â€‹	æ¥å£è¿”å›çš„æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š

```json
{
  "choices": [
    {
      "finish_reason": "stop",
      "index": 0,
      "message": {
        "content": "\u4f60\u597d\uff01\u6709\u4ec0\u4e48\u6211\u53ef\u4ee5\u5e2e\u52a9\u4f60\u7684\u5417\uff1f",
        "role": "assistant"
      }
    }
  ],
  "created": 1683438625,
  "id": "chatcmpl-7DRZp3IWnHvfasXtKl4KOGCgrVsFX",
  "model": "gpt-3.5-turbo-0301",
  "object": "chat.completion",
  "usage": {
    "completion_tokens": 18,
    "prompt_tokens": 23,
    "total_tokens": 41
  }
}
```

â€‹	ä»¥ä¸‹ä¸ºå¯¹è¯ç”Ÿæˆæ¨¡å—çš„æµ‹è¯•ä»£ç ï¼ˆè°ƒç”¨open ai çš„æ¥å£éœ€è¦ç¿»å¢™ä»¥åŠå……å€¼ï¼Œç¿»å¢™å’Œå……å€¼çš„å…·ä½“ç»†èŠ‚å°±ä¸åœ¨æœ¬æŠ¥å‘Šä¸­å±•å¼€äº†ï¼‰ï¼š

```python
import openai

# è®¾ç½® OpenAI API å¯†é’¥
openai.api_key = 'sk-xxx'

# è®¾ç½®promptï¼ˆç”¨äºæç¤ºçš„æ–‡æœ¬ï¼‰
prompt = "ä½ å¥½å‘€"

# ä½¿ç”¨ OpenAI API ç”Ÿæˆå¯¹è¯å›å¤
def generate_reply(prompt):
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": "You are a helpful assistant."},
            {"role": "user", "content": prompt}
        ],
        max_tokens=60,
        n=1,
        temperature=0.5,
    )
    # print(response)
    return response.choices[0].message.content.strip()


# æ‰“å°å¼€å§‹ä¿¡æ¯åŠç”Ÿæˆçš„å›å¤ï¼Œç”¨äºdebug
print("start")
print(generate_reply(prompt))
```

![image-20230507135204755](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507135204755.png)

### è¯­éŸ³åˆæˆTTS

â€‹	è¿™ä¸ªéƒ¨åˆ†æ˜¯æœ¬é¡¹ç›®è¾ƒå¤§çš„åˆ›æ–°ç‚¹ï¼Œå› ä¸ºæ²¡æœ‰ç›´æ¥è°ƒç”¨ç°æˆçš„apiã€‚è€Œæ˜¯åœ¨æœ¬åœ°éƒ¨ç½²`VITS`æ¨¡å‹è¿›è¡Œç”Ÿæˆã€‚

â€‹	`VITSï¼ˆVariational Inference with adversarial learning for end-to-end Text-to-Speechï¼‰`æ˜¯ä¸€ç§ç»“åˆå˜åˆ†æ¨ç†ï¼ˆvariational inferenceï¼‰ã€æ ‡å‡†åŒ–æµï¼ˆnormalizing flowsï¼‰å’Œå¯¹æŠ—è®­ç»ƒçš„é«˜è¡¨ç°åŠ›è¯­éŸ³åˆæˆæ¨¡å‹ã€‚VITSé€šè¿‡éšå˜é‡è€Œéé¢‘è°±ä¸²è”èµ·æ¥è¯­éŸ³åˆæˆä¸­çš„å£°å­¦æ¨¡å‹å’Œå£°ç å™¨ï¼Œåœ¨éšå˜é‡ä¸Šè¿›è¡Œéšæœºå»ºæ¨¡å¹¶åˆ©ç”¨éšæœºæ—¶é•¿é¢„æµ‹å™¨ï¼Œæé«˜äº†åˆæˆè¯­éŸ³çš„å¤šæ ·æ€§ï¼Œè¾“å…¥åŒæ ·çš„æ–‡æœ¬ï¼Œèƒ½å¤Ÿåˆæˆä¸åŒå£°è°ƒå’ŒéŸµå¾‹çš„è¯­éŸ³ã€‚

â€‹	åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œè€ƒè™‘åˆ°æˆ‘ç¬”è®°æœ¬ç®—åŠ›çš„å±€é™æ€§ï¼Œæˆ‘ç›´æ¥ä¸‹è½½äº†ç½‘ç»œä¸Šåˆ«äººè®­ç»ƒå¥½çš„æ´¾è’™éŸ³æ•ˆçš„æ¨¡å‹æ–‡ä»¶ï¼Œè¶…è¿‡400MBçš„`Paimon.pth`ã€‚å¹¶ä¸”æˆªå–äº†`VITS`ä¸­æ¨ç†éƒ¨åˆ†ã€‚æœ¬æ¨¡å—æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

```python
import socket
import torch
import utils
from models import SynthesizerTrn
from text.symbols import symbols
import soundfile as sf

# é…ç½®æ–‡ä»¶åï¼Œä¿å­˜è·¯å¾„ç­‰å‚æ•°
text = "æ—…è¡Œè€…ï¼Œæˆ‘åœ¨"
length_scale = 1
filename = 'results/result123'
audio_path = f'{filename}.mp3'

# åˆ›å»ºæ¨¡å‹ï¼ŒåŠ è½½æ´¾è’™éŸ³æ•ˆæ¨¡å‹å‚æ•°
hps = utils.get_hparams_from_file("./configs/biaobei_base.json")
model = SynthesizerTrn(
    len(symbols),
    hps.data.filter_length // 2 + 1,
    hps.train.segment_size // hps.data.hop_length,
    **hps.model).cuda()
model.eval()
utils.load_checkpoint('model/Paimon.pth', model)


stn_tst = utils.get_text(text, hps)
with torch.no_grad():
    x_tst = stn_tst.cuda().unsqueeze(0)
    x_tst_lengths = torch.LongTensor([stn_tst.size(0)]).cuda()
    audio = model.infer(x_tst, x_tst_lengths, noise_scale=.667, noise_scale_w=0.8, length_scale=length_scale)[0][
        0, 0].data.cpu().float().numpy()
    # å°†è¯­éŸ³åˆæˆçš„ç»“æœå†™å…¥åˆ°æŒ‡å®šmp3æ–‡ä»¶ä¸­
    sf.write(audio_path, audio, samplerate=hps.data.sampling_rate)

print("å·²å®Œæˆè¯­éŸ³ç”Ÿæˆ")
```

ğŸ¤” é‚£ä¹ˆï¼Œåªè¦å°†æ‰€æœ‰æ¨¡å—çš„ä»£ç è¿›è¡Œæ•´åˆï¼Œç„¶ååœ¨æ ‘è“æ´¾ä¸Šè¿è¡Œå°±å¯ä»¥äº†ï¼Ÿ

:cry: å¹¶ä¸æ˜¯ï¼Œæˆ‘åœ¨æµ‹è¯•è¿™ä¸ªæ¨ç†æ¨¡å‹çš„æ—¶å€™ï¼Œæ˜¯ä½¿ç”¨çš„ç¬”è®°æœ¬WSLçš„ç¯å¢ƒï¼Œå½“æˆ‘æŠŠç›¸åŒçš„ä»£ç æ‹·è´åˆ°æ ‘è“æ´¾ä¸Šçš„æ—¶å€™ï¼Œå‡ºç°äº†`Illegal instruction (cure dump)`çš„æŠ¥é”™ã€‚æˆ‘å°è¯•äº†å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„pytorchï¼Œå¹¶ä¸”åˆ é™¤äº†æ‰€æœ‰æ¶‰åŠæŠŠæ•°æ®è½¬ç§»åˆ°gpuçš„ä»£ç ï¼Œéƒ½æ— æœã€‚ä¸€åº¦æƒ³è¿‡æ”¾å¼ƒã€‚åœ¨æœ€åˆæäº¤å±•ç¤ºä½œå“çš„æ—¶å€™ï¼Œæˆ‘æœ€å®Œæ•´çš„è§†é¢‘ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨ç™¾åº¦apiè¿›è¡Œè¯­éŸ³åˆæˆã€‚åœ¨é¢„çº¦è¯¾ç¨‹å±•ç¤ºå½“å¤©æ—©ä¸Šï¼Œæˆ‘çªç„¶æƒ³åˆ°ï¼Œå¯ä»¥é€šè¿‡ç½‘ç»œæ¥ä¼ é€’æ–‡ä»¶ã€‚å°±æŠŠæˆ‘çš„ç¬”è®°æœ¬ä½œä¸ºä¸€ä¸ªè¯­éŸ³åˆæˆçš„æœåŠ¡å™¨ï¼Œç„¶åæŠŠç¬”è®°æœ¬ä¸Šåˆæˆçš„ç»“æœå‘ç»™æ ‘è“æ´¾ä¸å°±å¯ä»¥äº†ï¼Ÿäºæ˜¯ï¼Œä¾¿æœ‰äº†ä¸€ä¸‹çš„è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯æˆ‘å®ç°æ´¾è’™è¯­éŸ³åŠ©æ‰‹æœ€å…³é”®çš„ä¸€æ­¥ï¼ˆæ¯•ç«Ÿï¼Œæ²¡æœ‰æ´¾è’™éŸ³æ•ˆçš„è¯­éŸ³åŠ©æ‰‹æ€ä¹ˆèƒ½ç§°ä½œæ´¾è’™è¯­éŸ³åŠ©æ‰‹å‘¢ï¼Ÿï¼‰ï¼š

![image-20230507142647277](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507142647277.png)

â€‹	å½“æµ‹è¯•demoè·‘é€šçš„æ—¶å€™ï¼Œæˆ‘éå¸¸æ¿€åŠ¨ã€‚ä½†æ˜¯ï¼Œæˆ‘é©¬ä¸Šå‘ç°äº†é—®é¢˜ï¼šå› ä¸ºä»¥å¤ªç½‘çš„MTUï¼ˆMaxitum Transmission Unit æœ€å¤§ä¼ è¾“å•å…ƒï¼‰æ˜¯1500å­—èŠ‚ï¼Œè¿™å¯¹äºæˆ‘ä»¬çš„éŸ³é¢‘æ–‡ä»¶æ¥è¯´ï¼Œä¸€æ¬¡sendæ˜¾ç„¶æ˜¯ä¸è¶³å¤Ÿçš„ã€‚è¿™å¯¼è‡´ï¼Œæˆ‘åœ¨æ ‘è“æ´¾ä¸Šæ¥æ”¶åˆ°çš„éŸ³é¢‘ï¼Œåªèƒ½æ’­æ”¾ä¸å®Œæ•´çš„ä¸€å°æ®µã€‚ä¸ºäº†è§£å†³socketçš„å¤§æ–‡ä»¶ä¼ è¾“é€šè¿‡sendallæ‹†åˆ†æˆå¤šä¸ªå°åŒ…å‘é€ã€‚å¹¶ä¸”åœ¨å‘é€å‰ï¼Œé¦–å…ˆå‘æ ‘è“æ´¾é€šçŸ¥æ–‡ä»¶çš„å®Œæ•´å¤§å°ï¼Œæ­¤åï¼ŒæœåŠ¡ç«¯é€šè¿‡sendallå‘é€æ•°æ®ï¼Œè€Œå®¢æˆ·ç«¯ï¼ˆæ ‘è“æ´¾ï¼‰åˆ™æ ¸éªŒå·²ç»æ¥æ”¶åˆ°çš„æ–‡ä»¶å¤§å°ï¼Œåœ¨æœªè¾¾åˆ°å…ˆå‰å‘ŠçŸ¥çš„æ–‡ä»¶çš„å®Œæ•´å¤§å°ä¹‹å‰ï¼Œå¾ªç¯è°ƒç”¨recvï¼Œä»¥appendçš„æ–¹å¼è¿›è¡Œæ¥æ”¶ã€‚

â€‹	å› ä¸ºæ˜¯æœ¬åœ°éƒ¨ç½²çš„æ¨¡å‹ï¼Œæ‰€ä»¥è‚¯å®šæ²¡æœ‰ç™¾åº¦çš„è¯­éŸ³åˆæˆé‚£ä¹ˆæ™ºèƒ½ã€‚åœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘å‘ç°ï¼ŒVITSå¹¶ä¸èƒ½å°†0-9çš„é˜¿æ‹‰ä¼¯æ•°å­—è½¬å˜ä¸ºè¯­éŸ³ï¼Œè€Œæ˜¯é€‰æ‹©ç›´æ¥ç•¥è¿‡ã€‚æ‰€ä»¥æˆ‘å†™äº†è¾…åŠ©å‡½æ•°`convert_number_to_chinese`æ¥å¸®åŠ©å°†æ•°å­—è½¬æ¢ä¸ºæ±‰å­—çš„æ ¼å¼ã€‚æœ‰ä¸€äº›ç‰¹åˆ«éœ€è¦æ³¨æ„çš„ç‚¹æ˜¯å¯¹äºäºŒä½æ•°77ï¼Œ70ç­‰ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥è½¬æ¢æˆä¸ƒä¸ƒï¼Œè€Œåº”è¯¥è½¬æ¢æˆä¸ƒåä¸ƒã€‚

```python
# æ ‘è“æ´¾
import socket
from playsound import playsound

server_addr = '172.23.116.224'
server_port = 8989

sk_pi = socket.socket() # å®ä¾‹åŒ–ä¸€ä¸ªsocketå¯¹è±¡
sk_pi.connect((server_addr, server_port)) # ä½œä¸ºclientå‘windowså‘èµ·è¯·æ±‚

text = "å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æ´¾è’™"
# å‘é€éœ€è¦åˆæˆçš„æ–‡å­—
sk_pi.send(text.encode('utf-8'))


ret = sk_pi.recv(1024).decode('utf-8')
len_file = int(ret)
sk_pi.send("Ack from piï¼šå·²çŸ¥éœ€è¦æ¥æ”¶å¤§å°ä¸º{}çš„æ–‡ä»¶".format(len_file).encode('utf-8'))

save_filename = 'audio_from_win.mp3'
already_receive = 0
with open(save_filename,'wb+') as f:
    while True:
        ret = sk_pi.recv(1024)
        f.write(ret)
        already_receive += len(ret)
        if already_receive >= len_file:
            break

playsound(save_filename)

sk_pi.send('Receive from piï¼šæ¥æ”¶æˆåŠŸ'.encode('utf-8'))
sk_pi.close()

# windows
import socket
import re

def convert_number_to_chinese(num):
    num = int(num)
    units = ['', 'å', 'ç™¾', 'åƒ']
    nums = 'é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹'
    result = []

    if num < 10:
        return nums[num]

    num_str = str(num)
    num_len = len(num_str)

    for i, n in enumerate(num_str):
        if n == '0':
            if result and result[-1] != 'é›¶':
                result.append('é›¶')
        else:
            result.append(nums[int(n)])
            result.append(units[num_len - i - 1])

    return ''.join(result).rstrip('é›¶')


import re
def replace_numbers_with_chinese(text):
    def replace(match):
        number = match.group(0)
        return convert_number_to_chinese(number)

    return re.sub(r'\d+', replace, text)

server_addr = '172.23.116.224'
server_port = 8989
listen_addr = '10.181.243.251'
listen_port = 6666

sk_s = socket.socket()  # å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡sk
sk_s.bind((listen_addr, listen_port))  # æŠŠåœ°å€ç»‘å®šåˆ°å¥—æ¥å­—
sk_s.listen()  # ç›‘å¬é“¾æ¥
print("windowså¼€å§‹ç›‘å¬")

while True:
    conn_pi, addr_pi = sk_s.accept()  # æ¥æ”¶å®¢æˆ·ç«¯é“¾æ¥
    print(addr_pi)  # æ‰“å°å‡ºå®¢æˆ·ç«¯çš„åœ°å€+ç«¯å£

    # å…ˆæ¥å—ç­‰å¾…è½¬æ¢æˆè¯­éŸ³çš„æ–‡æœ¬
    text = conn_pi.recv(1024).decode('utf-8')
    print('ä»piæ¥æ”¶ï¼š',text)

    # 2023/05/06 å»é™¤æ¢è¡Œç¬¦
    text = text.replace('\n', '')
    # print("å»é™¤æ¢è¡Œç¬¦åç»“æœ:")
    # print(text)
    pattern = re.compile(r"[^\da-zA-Z0-9\u4e00-\u9fa5]+")
    text = pattern.sub("ï¼Œ", text)
    text = replace_numbers_with_chinese(text)
    print(text)


    # å‘wslè¯·æ±‚ç”Ÿæˆè¯­éŸ³
    # ä½œä¸ºclientå‘wslå‘èµ·è¯·æ±‚
    sk_c = socket.socket()  # åˆ›å»ºå®¢æˆ·ç«¯å¥—æ¥å­—
    sk_c.connect((server_addr, server_port))  # è¿æ¥æœåŠ¡å™¨(ipåœ°å€+ç«¯å£)

    sk_c.send(text.encode('utf-8'))

    ret = sk_c.recv(1024)  # ç­‰å¾…wslå®Œæˆä»»åŠ¡çš„æ¶ˆæ¯
    print("ä»wslæ¥æ”¶ï¼š",ret.decode('utf-8'))
    sk_c.send('windowsæ”¶åˆ°æ¶ˆæ¯!'.encode('utf-8'))
    sk_c.close()  # å…³é—­å®¢æˆ·ç«¯å¥—æ¥å­—

    filename = './results/result123.mp3'
    with open(filename,"rb") as f:
        rdata = f.read()

    len_data = len(rdata)
    print("å‘piå‘é€çš„æ–‡ä»¶å¤§å°ä¸ºï¼š",len_data)
    conn_pi.send(str(len_data).encode('utf-8'))
    ret = conn_pi.recv(1024).decode('utf-8')
    print(ret)

    conn_pi.sendall(rdata)

    ret = conn_pi.recv(1024)
    print(ret.decode('utf-8'))
    conn_pi.close()  # å…³é—­å®¢æˆ·ç«¯å¥—æ¥å­—

sk_s.close()  # å…³é—­æœåŠ¡å™¨å¥—æ¥å­—

# WSL
import socket
import torch
import utils
from models import SynthesizerTrn
from text.symbols import symbols
import soundfile as sf

text = "æ—…è¡Œè€…ï¼Œæˆ‘åœ¨"
length_scale = 1
filename = 'results/result123'
audio_path = f'{filename}.mp3'
# åˆ›å»ºæ¨¡å‹ï¼ŒåŠ è½½æ´¾è’™è¯­éŸ³åˆæˆæ¨¡å‹å‚æ•°
hps = utils.get_hparams_from_file("./configs/biaobei_base.json")
model = SynthesizerTrn(
    len(symbols),
    hps.data.filter_length // 2 + 1,
    hps.train.segment_size // hps.data.hop_length,
    **hps.model).cuda()
model.eval()
utils.load_checkpoint('model/Paimon.pth', model)


listen_addr = '172.23.116.224'
listen_port = 8989

sk = socket.socket()  # å®ä¾‹åŒ–ä¸€ä¸ªsocketå¯¹è±¡
sk.bind((listen_addr, listen_port))  # æŠŠåœ°å€ç»‘å®šåˆ°å¥—æ¥å­—
sk.listen()  # ç›‘å¬é“¾æ¥
print("å¼€å§‹ç›‘å¬")
while True:
    # ç­‰å¾…windowsç”¨æˆ·å‘é€è¯·æ±‚
    conn, addr = sk.accept()  # æ¥æ”¶å®¢æˆ·ç«¯é“¾æ¥
    print(addr)  # æ‰“å°å‡ºå®¢æˆ·ç«¯çš„åœ°å€+ç«¯å£


    text = conn.recv(1024).decode('utf-8')
    text.replace('\n', ' ')
    print("ä»windwosæ”¶åˆ°ï¼Œéœ€è¦è½¬æ¢çš„æ–‡æœ¬ä¸ºï¼š",text)

    # è¿›è¡Œæ¨ç†ï¼ˆè¯­éŸ³åˆæˆï¼‰
    stn_tst = utils.get_text(text, hps)
    with torch.no_grad():
        x_tst = stn_tst.cuda().unsqueeze(0)
        x_tst_lengths = torch.LongTensor([stn_tst.size(0)]).cuda()
        audio = model.infer(x_tst, x_tst_lengths, noise_scale=.667, noise_scale_w=0.8, length_scale=length_scale)[0][
            0, 0].data.cpu().float().numpy()
    sf.write(audio_path, audio, samplerate=hps.data.sampling_rate)


    conn.send('å·²å®Œæˆè¯­éŸ³ç”Ÿæˆ'.encode('utf-8'))  # å‘å®¢æˆ·ç«¯(windows)å‘é€åˆæˆå®Œæˆçš„ä¿¡æ¯
    print("å·²å®Œæˆè¯­éŸ³ç”Ÿæˆ")
    ret = conn.recv(1024)  # æ¥æ”¶å®¢æˆ·ç«¯ä¿¡æ¯(1024å­—èŠ‚)
    print(ret.decode('utf-8'))  # æ‰“å°å®¢æˆ·ç«¯ä¿¡æ¯(bytesç±»å‹éœ€è¦decode)
    conn.close()  # å…³é—­å®¢æˆ·ç«¯å¥—æ¥å­—
sk.close()  # å…³é—­æœåŠ¡å™¨å¥—æ¥å­—
```

![image-20230507151006904](C:\Users\11523\AppData\Roaming\Typora\typora-user-images\image-20230507151006904.png)

### æ’­æ”¾è¯­éŸ³åˆæˆçš„ç»“æœ

â€‹	åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘æ˜¯ç”¨äº†`playsound`æ¥æ’­æ”¾éŸ³é¢‘ã€‚ä»£ç ä¹Ÿéå¸¸ç®€å•ã€‚

```python
playsound('audio.mp3') # ä¼ å…¥çš„å‚æ•°ä¸ºéœ€è¦æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶å
```

â€‹	ä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œå’Œ`pyaudio`ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨`pip install playsound`ä¹‹å‰éœ€è¦å®‰è£…ä»¥ä¸‹ä¾èµ–é¡¹

```bash
sudo apt install python3-gi python3-gi-cairo gir1.2-gtk-3.0
```

### æ¡†æ¶æ•´åˆ

â€‹	ä»¥ä¸Šä»‹ç»äº†æœ¬è¯­éŸ³åŠ©æ‰‹çš„å„ä¸ªæ¨¡å—ï¼Œæœ€åï¼Œæˆ‘ç¼–å†™äº†`pmain.py`ä»£ç ï¼Œä½œä¸ºç¨‹åºçš„ä¸»å¾ªç¯ï¼ŒæŒ‰åºè°ƒç”¨å„ä¸ªæ¨¡å—ã€‚è‡³æ­¤ï¼Œæ´¾è’™è¯­éŸ³åŠ©æ‰‹å…¨éƒ¨å®Œæˆã€‚

```python
import u_tasks
from hotword import snowboydecoder
import sys
import signal
import speech_recognition as sr
from playsound import playsound
from aip import AipSpeech
import openai
import time
import u_record
import socket
from playsound import playsound

server_addr = '10.181.243.251'
server_port = 6666

# æ›¿æ¢ä¸ºæ‚¨çš„ç™¾åº¦ API å¯†é’¥
BAIDU_APP_ID = 'xxx'
BAIDU_API_KEY = 'xxx'
BAIDU_SECRET_KEY = 'xxx'

# æ›¿æ¢ä¸ºæ‚¨çš„ OpenAI API å¯†é’¥
OPENAI_API_KEY = 'sk-xxx'

MAX_LENGTH = 100


openai.api_key = OPENAI_API_KEY

# åˆ›å»ºä¸€ä¸ª AipSpeech å¯¹è±¡
baidu_client = AipSpeech(BAIDU_APP_ID, BAIDU_API_KEY, BAIDU_SECRET_KEY)

interrupted = False

# å°†ç”¨æˆ·çš„è¯­éŸ³ä¿å­˜ä¸ºæ–‡ä»¶
def save_audio_to_file(audio, filename):
    with open(filename, "wb") as file:
        file.write(audio.get_wav_data())

def signal_handler(signal, frame):
    global interrupted
    interrupted = True

def interrupt_callback():
    global interrupted
    return interrupted

def detected_callback():
    playsound("paimon_response.mp3")
    time.sleep(1)
    # print("å”¤é†’è¯å·²æ£€æµ‹åˆ°ï¼")
    recognize_and_respond()

def recognize_and_respond():

    print("æ­£åœ¨å€¾å¬æ‚¨çš„é—®é¢˜...")
    u_record.record_wav("output.wav")
    # try:
    print("æ­£åœ¨è¯†åˆ«è¯­éŸ³...")
    # å°†éŸ³é¢‘è½¬æ¢ä¸ºå¯è¯†åˆ«çš„æ ¼å¼
    # audio_data = audio.get_wav_data()
    audio_data = open("output.wav","rb").read()
    # 1537è¡¨ç¤ºä¸­æ–‡
    response = baidu_client.asr(audio_data, 'wav', 16000, {'dev_pid': 1537})

    # print(response)
    if response['err_no'] == 0:
        text = response['result'][0]
        print(f"æ‚¨è¯´äº†ï¼š{text}")

        response_text = ""
        # åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æ®Šä»»åŠ¡
        if text == "ä¸€é”®ç­¾åˆ°ã€‚":
            response_text = u_tasks.signYS()
        elif text == "æˆ‘è¦çœ‹å¸–å­ã€‚":
            response_text = u_tasks.getYSArticle()
        elif u_tasks.is_query_weather(text):
            response_text = u_tasks.query_weather(text)
        else:
            # è‹¥éƒ½ä¸æ˜¯ï¼Œåˆ™è°ƒç”¨chatgptçš„apiç”Ÿæˆå›å¤

            # add length limit
            text += "è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œå¹¶æ§åˆ¶åœ¨{}å­—ä»¥å†…ã€‚".format(MAX_LENGTH)
            response_text = generate_response(text)

        # chatgpt å›å¤æ–‡å­— -> è¯­éŸ³(è°ƒç”¨ç™¾åº¦api)
        # tts_result = baidu_client.synthesis(response_text, 'zh', 1, {'vol': 5,'per': 0,})
        # if not isinstance(tts_result, dict):
        #     with open('audio.mp3', 'wb') as f:
        #         f.write(tts_result)

        sk_pi = socket.socket()
        sk_pi.connect((server_addr, server_port))

        text = response_text
        sk_pi.send(text.encode('utf-8'))

        ret = sk_pi.recv(1024).decode('utf-8')
        len_file = int(ret)
        sk_pi.send("å³å°†æ¥æ”¶å¤§å°ä¸º{}çš„æ–‡ä»¶".format(len_file).encode('utf-8'))

        save_filename = 'audio.mp3'
        already_receive = 0
        with open(save_filename,'wb+') as f:
            while True:
                ret = sk_pi.recv(1024)
                f.write(ret)
                already_receive += len(ret)
                if already_receive >= len_file:
                    break

        print(f"åŠ©æ‰‹å›ç­”ï¼š{response_text}")
        playsound('audio.mp3')

    else:
        print("æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰å¬æ¸…æ¥šã€‚")


def generate_response(prompt):
    print("ç­‰å¾…chatgptç”Ÿæˆå›å¤...")
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": "You are a helpful assistant."},
            {"role": "user", "content": prompt}
        ],
        max_tokens=60,
        n=1,
        temperature=0.5,
    )
    
    message = response.choices[0].message.content.strip()
    return message

# æ›¿æ¢ä¸ºæ‚¨çš„æ¨¡å‹æ–‡ä»¶è·¯å¾„
model_path = './hotword/resources/models/paimeng.pmdl'

signal.signal(signal.SIGINT, signal_handler)

detector = snowboydecoder.HotwordDetector(model_path, sensitivity=0.5)
print("æ­£åœ¨ç›‘å¬å”¤é†’è¯ï¼Œè¯·è¯´è¯...")

# main loop
detector.start(detected_callback=detected_callback,
              interrupt_check=interrupt_callback,
              sleep_time=0.03)

detector.terminate()
```

## å‚è€ƒèµ„æ–™

[Snowboyå”¤é†’](https://www.bilibili.com/video/av765440071/?vd_source=2a09b1db312a9ed3fb414711810b3bf0)

[pyaudioè¯­éŸ³å½•åˆ¶](https://blog.csdn.net/weixin_42407261/article/details/125052868)

[ç™¾åº¦AIè¯­éŸ³æŠ€æœ¯api](https://cloud.baidu.com/doc/SPEECH/s/1k4o0bmc7)

[jiebaåˆ†è¯åŸç†](https://blog.csdn.net/yaohaishen/article/details/114825567)

[Pythonçˆ¬è™«å¤©æ°”æŸ¥è¯¢](https://www.yingsoo.com/news/devops/71987.html)

[ç±³æ¸¸å¸è„šæœ¬](https://github.com/XiaoMiku01/miyoubiAuto)

[openAI apiä¸­æ–‡æ–‡æ¡£](https://openai.xiniushu.com/docs/models)

[VITSè¯­éŸ³åˆæˆ](https://github.com/AlexandaJerry/vits-mandarin-biaobei)

[Socketç¼–ç¨‹](https://www.cnblogs.com/bainianminguo/p/7223177.html)

